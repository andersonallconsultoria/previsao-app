<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Configura√ß√£o de Previs√£o</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
  <style>
    /* Paleta COE - Estilo dos filtros */
    .coe-section {
      background: linear-gradient(135deg, #004AAD, #1ABC9C);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 25px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .coe-section .form-label {
      color: white !important;
      font-weight: 500;
    }
    
    .coe-section .form-select,
    .coe-section .form-control {
      background-color: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .coe-section .form-select:focus,
    .coe-section .form-control:focus {
      background-color: white;
      border-color: rgba(255, 255, 255, 0.5);
      box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.5);
    }
    
    .coe-section .btn-primary {
      background-color: #FF6B00 !important;
      color: #FFFFFF !important;
      border: none !important;
      font-weight: 500 !important;
    }
    
    .coe-section .btn-primary:hover {
      background-color: #e85500 !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      color: #FFFFFF !important;
    }
    
    /* Estilo dos filtros de configura√ß√£o existente */
    .filtros-config {
      background: linear-gradient(135deg, #004AAD, #1ABC9C);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .filtros-config .form-label {
      color: white !important;
      font-weight: 500;
      font-size: 14px;
    }
    
    .filtros-config .form-select {
      background-color: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .filtros-config .form-select:focus {
      background-color: white;
      border-color: rgba(255, 255, 255, 0.5);
      box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.5);
    }
    
    /* Fundo gradiente COE para toda a p√°gina */
    body {
      background: linear-gradient(135deg, #004AAD, #1ABC9C);
      min-height: 100vh;
    }
    
    /* Container principal com fundo transparente */
    .container.py-4 {
      background: transparent;
    }
    
    /* Garante que a tabela tenha fundo branco */
    #table-container {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* T√≠tulo em branco para contrastar com o fundo gradiente */
    h2 {
      color: white !important;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      font-weight: 600;
    }
    
    h4 {
      color: white !important;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      font-weight: 500;
    }
    
    /* Bot√£o Voltar com cor cinza-azulado neutro */
    .btn-secondary {
      background-color: #546E7A !important;
      color: #FFFFFF !important;
      border: none !important;
      font-weight: 500 !important;
    }
    
    .btn-secondary:hover {
      background-color: #455a64 !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      color: #FFFFFF !important;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">Configura√ß√£o de Previs√£o</h2>
      <a href="{% url 'painel' %}" class="btn btn-secondary">‚¨Ö Voltar</a>
    </div>
    
    <form method="post" action="{% url 'salvar_configuracao' %}" class="coe-section">
      {% csrf_token %}
      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">Empresa</label>
          <select name="empresa" class="form-select" required>
            <option value="">Selecione...</option>
            {% for emp in empresas %}
              <option value="{{ emp.idempresa }}">{{ emp.empresa }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Centro de Resultado</label>
          <select name="centro" class="form-select" required>
            <option value="">Selecione...</option>
            {% for cr in centros %}
              <option value="{{ cr.idcentroresultado }}">{{ cr.centroresultados }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Conta Cont√°bil</label>
          <select name="conta" class="form-select" id="conta-select-new" required>
            <option value="">Selecione...</option>
            {% for cta in contas %}
              <option value="{{ cta.idctacontabil }}">{{ cta.contabil }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-3">
          <label class="form-label">M√™s</label>
          <select name="mes" class="form-select">
            <option value="">-- opcional --</option>
            {% for num, nome in meses %}
              <option value="{{ num }}">{{ nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Tipo</label>
          <select name="tipo" class="form-select" required>
            <option value="V">Valor Manual</option>
            <option value="P">Percentual</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Valor / Percentual</label>
          <input type="number" step="0.01" name="valor" class="form-control" required>
        </div>
        <div class="col-md-3 d-grid align-items-end">
          <button type="submit" class="btn btn-primary mt-3">Salvar</button>
        </div>
      </div>
    </form>

    <hr class="my-4">

    <h4>Configura√ß√µes Existentes</h4>
    {% if configuracoes %}
      <div class="mb-3 row g-2 filtros-config">
        <div class="col-md-4">
          <label class="form-label">üîç Filtrar por Empresa</label>
          <select class="form-select form-select-sm" id="filter-empresa">
            <option value="">Todas as empresas</option>
            {% for emp in empresas %}
              <option value="{{ emp.idempresa }}">{{ emp.empresa }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">üîç Filtrar por Centro</label>
          <select class="form-select form-select-sm" id="filter-centro">
            <option value="">Todos os centros</option>
            {% for cr in centros %}
              <option value="{{ cr.idcentroresultado }}">{{ cr.centroresultados }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">üîç Filtrar por Conta</label>
          <select class="form-select form-select-sm" id="filter-conta">
            <option value="">Todas as contas</option>
            {% for cta in contas %}
              <option value="{{ cta.idctacontabil }}">{{ cta.contabil }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      
      <div id="table-container" style="max-height: 500px; overflow-y: auto; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
        <table class="table table-striped table-hover" id="config-table">
          <thead class="table-dark sticky-top">
            <tr>
              <th>#</th>
            <th>Empresa</th>
            <th>Centro Resultado</th>
            <th>Conta Cont√°bil</th>
            <th>M√™s</th>
            <th>Tipo</th>
            <th>Valor</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          {% for item in configuracoes %}
            <tr data-id="{{ forloop.counter0 }}" class="config-row">
              <td>{{ forloop.counter }}</td>
            <td class="empresa">{{ item.ideempprevisao }}</td>
            <td class="centro">{{ item.idcentroresultado }}</td>
            <td class="conta">{{ item.idctacontabil }}</td>
              <td class="mes">{{ item.mesprevisao|default:"-" }}</td>
            <td class="tipo">{{ item.tipoprevisao }}</td>
            <td class="valor">{{ item.valorprevisao }}</td>
            <td>
              <button type="button" class="btn btn-sm btn-outline-primary btn-editar">Editar</button>
              <button type="button" class="btn btn-sm btn-success btn-salvar d-none">Salvar</button>
              <button type="button" class="btn btn-sm btn-secondary btn-cancelar d-none">Cancelar</button>
                <button type="button" class="btn btn-sm btn-outline-danger btn-excluir ms-1">üóëÔ∏è Excluir</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      </div>
      
      <!-- Pagina√ß√£o -->
      <nav aria-label="Pagina√ß√£o de configura√ß√µes" style="padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); margin-top: 15px;">
        <ul class="pagination justify-content-center" id="pagination">
          <!-- Ser√° preenchido via JavaScript -->
        </ul>
      </nav>
      
      <div class="text-center mt-2" style="padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
        <span class="text-muted" id="page-info">Mostrando 0 de 0 configura√ß√µes</span>
      </div>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const table = document.getElementById('config-table');
          let editando = null;

          // ========== PAGINA√á√ÉO ==========
          const itemsPerPage = 50;
          let currentPage = 1;
          let filteredRows = Array.from(document.querySelectorAll('.config-row'));
          
          function renderPage() {
            const tbody = table.querySelector('tbody');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageRows = filteredRows.slice(startIndex, endIndex);
            const totalRows = filteredRows.length;
            
            // Remove todas as linhas
            tbody.querySelectorAll('.config-row').forEach(row => row.remove());
            
            // Adiciona apenas as linhas da p√°gina atual
            pageRows.forEach(row => tbody.appendChild(row));
            
            // Atualiza pagina√ß√£o
            updatePagination(totalRows);
            updatePageInfo(totalRows, startIndex, endIndex);
          }
          
          // Armazenar todas as linhas originais
          const allRows = Array.from(document.querySelectorAll('.config-row'));
          
          // Fun√ß√£o para aplicar event listeners
          function bindEventListeners() {
            attachRowEventListeners();
          }
          
          function updatePagination(totalRows) {
            const totalPages = Math.ceil(totalRows / itemsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // Bot√£o Anterior
            const prevBtn = document.createElement('li');
            prevBtn.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevBtn.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">¬´ Anterior</a>`;
            pagination.appendChild(prevBtn);
            
            // N√∫meros de p√°gina
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
              const firstPage = document.createElement('li');
              firstPage.className = 'page-item';
              firstPage.innerHTML = `<a class="page-link" href="#" data-page="1">1</a>`;
              pagination.appendChild(firstPage);
              
              if (startPage > 2) {
                const ellipsis = document.createElement('li');
                ellipsis.className = 'page-item disabled';
                ellipsis.innerHTML = '<span class="page-link">...</span>';
                pagination.appendChild(ellipsis);
              }
            }
            
            for (let i = startPage; i <= endPage; i++) {
              const pageBtn = document.createElement('li');
              pageBtn.className = `page-item ${i === currentPage ? 'active' : ''}`;
              pageBtn.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
              pagination.appendChild(pageBtn);
            }
            
            if (endPage < totalPages) {
              if (endPage < totalPages - 1) {
                const ellipsis = document.createElement('li');
                ellipsis.className = 'page-item disabled';
                ellipsis.innerHTML = '<span class="page-link">...</span>';
                pagination.appendChild(ellipsis);
              }
              
              const lastPage = document.createElement('li');
              lastPage.className = 'page-item';
              lastPage.innerHTML = `<a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a>`;
              pagination.appendChild(lastPage);
            }
            
            // Bot√£o Pr√≥ximo
            const nextBtn = document.createElement('li');
            nextBtn.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextBtn.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Pr√≥ximo ¬ª</a>`;
            pagination.appendChild(nextBtn);
            
            // Event listeners para os bot√µes
            pagination.querySelectorAll('.page-link').forEach(link => {
              link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.dataset.page);
                if (page && page >= 1 && page <= totalPages) {
                  currentPage = page;
                  renderPage();
                  bindEventListeners();
                }
              });
            });
          }
          
          function updatePageInfo(totalRows, startIndex, endIndex) {
            const actualEnd = Math.min(endIndex, totalRows);
            const info = document.getElementById('page-info');
            info.textContent = `Mostrando ${startIndex + 1} a ${actualEnd} de ${totalRows} configura√ß√µes`;
          }
          
          // Filtros (tornar global)
          window.applyFilters = function() {
            const empresaFilter = document.getElementById('filter-empresa').value;
            const centroFilter = document.getElementById('filter-centro').value;
            const contaFilter = document.getElementById('filter-conta').value;
            
            filteredRows = allRows.filter(row => {
              const empresa = row.querySelector('.empresa').textContent.trim();
              const centro = row.querySelector('.centro').textContent.trim();
              const conta = row.querySelector('.conta').textContent.trim();
              
              const matchEmpresa = !empresaFilter || empresa === empresaFilter;
              const matchCentro = !centroFilter || centro === centroFilter;
              const matchConta = !contaFilter || conta === contaFilter;
              
              return matchEmpresa && matchCentro && matchConta;
            });
            
            currentPage = 1;
            renderPage();
            bindEventListeners();
          }
          
          document.getElementById('filter-empresa').addEventListener('change', applyFilters);
          document.getElementById('filter-centro').addEventListener('change', applyFilters);
          // Event listener para filter-conta ser√° adicionado pelo Select2
          
          // Fun√ß√£o para aplicar event listeners aos bot√µes
          function bindEventListeners() {
            attachRowEventListeners();
          }
          
          function attachRowEventListeners() {
            bindEditors();
            bindCancel();
            bindSave();
            bindDelete();
          }
          
          function bindEditors() {
            // Remove listeners antigos
            const buttons = document.querySelectorAll('.btn-editar');
            buttons.forEach(btn => {
              const newBtn = btn.cloneNode(true);
              btn.parentNode.replaceChild(newBtn, btn);
            });
            
            // Adiciona novos listeners
            document.querySelectorAll('.btn-editar').forEach(function(btn) {
            btn.addEventListener('click', function() {
              if (editando) return; // S√≥ uma edi√ß√£o por vez
              const tr = btn.closest('tr');
              editando = tr;
              // Salva valores antigos
              tr.dataset.old = tr.innerHTML;
              // Troca c√©lulas por inputs
              tr.querySelectorAll('td').forEach(function(td, idx) {
                if (td.classList.contains('empresa') || td.classList.contains('centro') || td.classList.contains('conta') || td.classList.contains('mes') || td.classList.contains('tipo') || td.classList.contains('valor')) {
                  const valor = td.textContent.trim().replace(/\s+/g, '');
                  let input = '';
                  if (td.classList.contains('tipo')) {
                    input = `<select class='form-select form-select-sm'>\
                      <option value='V' ${valor==='V'?'selected':''}>V</option>\
                      <option value='P' ${valor==='P'?'selected':''}>P</option>\
                    </select>`;
                  } else if (td.classList.contains('valor')) {
                    // Para valor, converte v√≠rgula para ponto se necess√°rio
                    const valorNumerico = valor.replace(',', '.');
                    input = `<input type='number' step='0.01' class='form-control form-control-sm' value='${valorNumerico}'>`;
                  } else {
                    input = `<input type='text' class='form-control form-control-sm' value='${valor}'>`;
                  }
                  td.innerHTML = input;
                }
              });
              // Mostra bot√µes salvar/cancelar
              tr.querySelector('.btn-editar').classList.add('d-none');
              tr.querySelector('.btn-salvar').classList.remove('d-none');
              tr.querySelector('.btn-cancelar').classList.remove('d-none');
            });
          });
          }

          function bindCancel() {
            document.querySelectorAll('.btn-cancelar').forEach(function(btn) {
            btn.addEventListener('click', function() {
              if (!editando) return;
              // Restaura linha
              editando.innerHTML = editando.dataset.old;
              editando = null;
            });
          });
          }

          function bindSave() {
            document.querySelectorAll('.btn-salvar').forEach(function(btn) {
            btn.addEventListener('click', function() {
              if (!editando) return;
              const tr = editando;
              const empresa = tr.querySelector('.empresa input, .empresa select')?.value;
              const centro = tr.querySelector('.centro input, .centro select')?.value;
              const conta = tr.querySelector('.conta input, .conta select')?.value;
              const mes = tr.querySelector('.mes input, .mes select')?.value;
              const tipo = tr.querySelector('.tipo input, .tipo select')?.value;
              const valor = tr.querySelector('.valor input, .valor select')?.value;
              
              // Envia dados para o backend
              const formData = new FormData();
              formData.append('empresa', empresa);
              formData.append('centro', centro);
              formData.append('conta', conta);
              formData.append('mes', mes);
              formData.append('tipo', tipo);
              formData.append('valor', valor);
              formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

              fetch('{% url "atualizar_configuracao" %}', {
                method: 'POST',
                body: formData
              })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  // Atualiza a linha com os novos valores
                  editando.innerHTML = `<td class="empresa">${empresa}</td><td class="centro">${centro}</td><td class="conta">${conta}</td><td class="mes">${mes}</td><td class="tipo">${tipo}</td><td class="valor">${valor}</td><td><button type='button' class='btn btn-sm btn-outline-primary btn-editar'>Editar</button><button type='button' class='btn btn-sm btn-success btn-salvar d-none'>Salvar</button><button type='button' class='btn btn-sm btn-secondary btn-cancelar d-none'>Cancelar</button></td>`;
                  editando = null;
                  // Reaplica eventos
                  document.querySelectorAll('.btn-editar').forEach(function(btn) {
                    btn.onclick = function() { location.reload(); };
                  });
                  alert('Configura√ß√£o atualizada com sucesso!');
                } else {
                  alert('Erro ao atualizar: ' + data.message);
                }
              })
              .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao atualizar configura√ß√£o');
              });
            });
          });
          }
          
          function bindDelete() {
            document.querySelectorAll('.btn-excluir').forEach(function(btn) {
            btn.addEventListener('click', function() {
              if (!confirm('Tem certeza que deseja excluir esta configura√ß√£o?')) {
                return;
              }
              
              const tr = btn.closest('tr');
              const empresa = tr.querySelector('.empresa').textContent.trim();
              const centro = tr.querySelector('.centro').textContent.trim();
              const conta = tr.querySelector('.conta').textContent.trim();
              const mes = tr.querySelector('.mes').textContent.trim();
              
              console.log('üóëÔ∏è Dados para exclus√£o:', {
                empresa: empresa,
                centro: centro,
                conta: conta,
                mes: mes
              });
              
              // Envia dados para exclus√£o
              const formData = new FormData();
              formData.append('empresa', empresa);
              formData.append('centro', centro);
              formData.append('conta', conta);
              formData.append('mes', mes);
              formData.append('acao', 'D'); // D = DELETE
              formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

              fetch('{% url "salvar_configuracao" %}', {
                method: 'POST',
                headers: {
                  'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
              })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  // Remove a linha da tabela
                  tr.remove();
                  alert('Configura√ß√£o exclu√≠da com sucesso!');
                } else {
                  alert('Erro ao excluir: ' + data.message);
                }
              })
              .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao excluir configura√ß√£o');
              });
            });
          });
          }
          
          // Inicializar pagina√ß√£o
          renderPage();
          bindEventListeners();
        });
      </script>
      
      <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
      <script>
        $(document).ready(function() {
          // Inicializar Select2 no campo de Conta Cont√°bil (cadastro)
          $('#conta-select-new').select2({
            theme: 'bootstrap-5',
            placeholder: 'Digite para buscar...',
            allowClear: true,
            language: {
              noResults: function() { return 'Nenhum resultado encontrado'; },
              searching: function() { return 'Buscando...'; }
            }
          });
          
          // Inicializar Select2 no filtro de Conta
          $('#filter-conta').select2({
            theme: 'bootstrap-5',
            placeholder: 'Todas as contas',
            allowClear: true,
            language: {
              noResults: function() { return 'Nenhum resultado encontrado'; },
              searching: function() { return 'Buscando...'; }
            }
          });
          
          // Detectar mudan√ßas no filtro de conta e aplicar filtro
          setTimeout(function() {
            $('#filter-conta').on('select2:select select2:clear', function(e) {
              console.log('Select2 mudou, aplicando filtros...');
              console.log('Valor selecionado:', $('#filter-conta').val());
              // Aplicar filtros diretamente
              if (typeof window.applyFilters === 'function') {
                window.applyFilters();
              }
            });
          }, 100);
          
          // Garantir que o formul√°rio de cadastro envia o valor do Select2
          $('form').on('submit', function(e) {
            // Sincronizar Select2 com o select original antes do submit
            var selectValue = $('#conta-select-new').val();
            console.log('Enviando valor da conta:', selectValue);
            // O Select2 j√° faz isso automaticamente, mas vamos garantir
            $('#conta-select-new')[0].value = selectValue;
          });
        });
      </script>
    {% else %}
      <div class="alert alert-info">Nenhuma configura√ß√£o encontrada.</div>
    {% endif %}
  </div>
</body>
</html>
